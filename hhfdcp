<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í–‰ì •ì‘ìš©ë²• OX í€´ì¦ˆ 100ì œ</title>
<!-- Tailwind CSS CDN ë¡œë“œ (ìˆ˜ì • ì™„ë£Œ: ì˜¬ë°”ë¥¸ ì£¼ì†Œ ì‚¬ìš©) -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* Inter í°íŠ¸ ì‚¬ìš© ì„¤ì • ë° ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
body {
    font-family: "Inter", sans-serif;
    background-color: #f7f9fc;
}
.container {
    max-width: 768px; /* íƒœë¸”ë¦¿ í¬ê¸°ê¹Œì§€ í™•ì¥ */
}
.question-text-style {
    /* ì§ˆë¬¸ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    min-height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
}
.hidden {
    display: none;
}
/* ëª¨ë‹¬ ë°°ê²½ ìŠ¤íƒ€ì¼ */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 100;
}
</style>
</head>
<body class="p-4 sm:p-6 min-h-screen flex justify-center items-start pt-10">

<div id="app" class="container w-full bg-white shadow-2xl rounded-xl p-6 sm:p-8">
    <!-- Header and Scoreboard -->
    <header class="text-center mb-6 border-b pb-4">
        <h1 class="text-3xl font-extrabold text-blue-800">í–‰ì •ì‘ìš©ë²• OX í€´ì¦ˆ 100ì œ</h1>
        <p id="score" class="mt-2 text-lg font-medium text-gray-600">
            ì§„í–‰: <span id="current-index">0</span> / <span id="total-questions">0</span> | ì •ë‹µ: <span id="correct-count" class="text-green-600">0</span>ê°œ | ì˜¤ë‹µ: <span id="incorrect-count" class="text-red-600">0</span>ê°œ
        </p>
    </header>

    <!-- Quiz Area -->
    <main id="quiz-area">
        <!-- Question Card -->
        <div class="bg-blue-50 border-2 border-blue-200 p-6 rounded-2xl shadow-lg mb-8">
            <p id="question-id" class="text-xl font-bold text-blue-700 mb-3">ë¬¸ì œ 0.</p>
            <div class="question-text-style bg-white p-4 rounded-xl shadow-inner border border-blue-100">
                <p id="question-text" class="text-xl text-gray-800 font-medium leading-relaxed">í€´ì¦ˆë¥¼ ì‹œì‘í•˜ë ¤ë©´ 'ì‹œì‘í•˜ê¸°' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
            </div>
        </div>

        <!-- Answer Buttons -->
        <div id="answer-buttons" class="grid grid-cols-2 gap-4">
            <button id="btn-o" class="p-4 text-2xl font-extrabold text-white bg-green-500 rounded-xl shadow-lg hover:bg-green-600 transition duration-150 transform hover:scale-[1.02] active:scale-[0.98]">O</button>
            <button id="btn-x" class="p-4 text-2xl font-extrabold text-white bg-red-500 rounded-xl shadow-lg hover:bg-red-600 transition duration-150 transform hover:scale-[1.02] active:scale-[0.98]">X</button>
        </div>

        <!-- Result/Explanation Area -->
        <div id="result-area" class="mt-6 p-4 rounded-xl hidden transition-all duration-300">
            <p id="result-message" class="text-lg font-semibold mb-2"></p>
            <details class="bg-gray-100 p-3 rounded-lg border border-gray-300">
                <summary class="font-medium text-blue-600 cursor-pointer">í•´ì„¤ ë³´ê¸°</summary>
                <p id="explanation-text" class="text-sm mt-2 text-gray-700 leading-relaxed"></p>
                <p id="precedent-text" class="text-xs text-gray-500 italic mt-2 pt-2 border-t"></p>
            </details>
        </div>
        
        <!-- Navigation Button -->
        <div class="mt-6 flex justify-end">
            <button id="btn-next" class="p-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-150 transform hover:scale-105 active:scale-95 hidden">ë‹¤ìŒ ë¬¸ì œ &rarr;</button>
        </div>
    </main>
    
    <!-- Initial Start / End Screen -->
    <div id="start-end-screen" class="text-center p-8">
        <h2 id="final-message" class="text-2xl font-bold text-gray-700 mb-6">í€´ì¦ˆë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.</h2>
        <button id="btn-start" class="p-4 text-xl font-bold text-white bg-blue-600 rounded-xl shadow-lg hover:bg-blue-700 transition duration-150 transform hover:scale-[1.05] active:scale-95">ì‹œì‘í•˜ê¸° (100ë¬¸ì œ)</button>
        <button id="btn-review-incorrect" class="p-4 text-xl font-bold text-white bg-red-600 rounded-xl shadow-lg hover:bg-red-700 transition duration-150 transform hover:scale-[1.05] active:scale-95 mt-4 hidden">ì˜¤ë‹µ ë…¸íŠ¸ ë³µìŠµ ì‹œì‘</button>
        <button id="btn-show-incorrect" class="p-4 text-xl font-bold text-red-600 border border-red-600 bg-white rounded-xl shadow-lg hover:bg-red-50 transition duration-150 transform hover:scale-[1.02] active:scale-95 mt-4 hidden">ì˜¤ë‹µ ë…¸íŠ¸ ë³´ê¸°</button>
    </div>

</div>

<!-- ì˜¤ë‹µ ë…¸íŠ¸ ëª¨ë‹¬ -->
<div id="incorrect-note-modal" class="modal-overlay hidden">
    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-2xl w-11/12 max-w-lg max-h-[90vh] overflow-y-auto transform transition-all duration-300 scale-100">
        <h2 class="text-2xl font-bold text-red-700 border-b pb-3 mb-4">ì˜¤ë‹µ ë…¸íŠ¸</h2>
        <div id="incorrect-list" class="space-y-4">
            <!-- ì˜¤ë‹µ ëª©ë¡ì´ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤. -->
        </div>
        <div id="no-incorrect" class="text-center p-8 bg-gray-50 rounded-lg hidden">
            <p class="text-lg text-gray-600 font-medium">í˜„ì¬ ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤. í›Œë¥­í•´ìš”!</p>
        </div>
        <div class="mt-6 flex justify-end space-x-3">
            <button onclick="closeIncorrectNote()" class="p-3 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firestore Debugging
    setLogLevel('debug');

    // Global variables from Canvas environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Firebase Initialization
    let app, db, auth;
    let userId = null;
    let isAuthReady = false;

    if (Object.keys(firebaseConfig).length > 0) {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Authentication
            async function authenticate() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser?.uid || crypto.randomUUID();
                    isAuthReady = true;
                    console.log("Firebase Auth Ready. User ID:", userId);
                    loadUserData(); // ì¸ì¦ í›„ ë°ì´í„° ë¡œë“œ ì‹œì‘
                } catch (error) {
                    console.error("Firebase ì¸ì¦ ì‹¤íŒ¨:", error);
                    userId = crypto.randomUUID(); // ìµëª… ì‚¬ìš©ì ID ìƒì„±
                    isAuthReady = true;
                    loadUserData(); // ì‹¤íŒ¨í•´ë„ í€´ì¦ˆëŠ” ì§„í–‰í•  ìˆ˜ ìˆë„ë¡ ë°ì´í„° ë¡œë“œ ì‹œë„
                }
            }
            authenticate();
        } catch (error) {
            console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
        }
    } else {
        console.warn("Firebase ì„¤ì •ì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë°ì´í„°ë¥¼ ì €ì¥/ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        isAuthReady = true;
        userId = crypto.randomUUID();
    }


    // --- í€´ì¦ˆ ë°ì´í„° ë° ìƒíƒœ ---
    const questions = [
        { id: 1, q: "í–‰ì •ì²­ì´ ëŒ€ì§‘í–‰ ê³„ê³ ë¥¼ í•  ë•Œ ë¬¸ì„œì— ì˜í•œ í†µì§€ëŠ” ë°˜ë“œì‹œ í•„ìš”í•˜ë‹¤. (íŒë¡€)", a: false, explanation: "íŒë¡€ëŠ” í–‰ì •ëŒ€ì§‘í–‰ ê³„ê³ ì˜ í†µì§€ê°€ ìƒëŒ€ë°©ì—ê²Œ ë„ë‹¬ëœ ì´ìƒ ë¬¸ì„œì— ì˜í•˜ì§€ ì•„ë‹ˆí•˜ì˜€ë‹¤ í•˜ë”ë¼ë„ ìœ„ë²•í•˜ë‹¤ê³  ë³¼ ìˆ˜ ì—†ë‹¤ê³  í•©ë‹ˆë‹¤.", precedent: "ëŒ€ë²•ì› 1999. 4. 27. ì„ ê³  99ë‘1286 íŒê²°" },
        { id: 2, q: "ì¬ëŸ‰í–‰ìœ„ì— ìˆì–´ì„œë„ ë²•ê·œê°€ ì •í•˜ëŠ” ìš”ê±´ì„ ì¶©ì¡±í•˜ë©´ ë°˜ë“œì‹œ ê¸°ì†í–‰ìœ„ë¡œ ë°”ë€ë‹¤.", a: false, explanation: "ì¬ëŸ‰í–‰ìœ„ëŠ” ì›ì¹™ì ìœ¼ë¡œ ê¸°ì†í–‰ìœ„ë¡œ ë°”ë€Œì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ë§Œ, í–‰ì •ê·œì¹™ ë“±ì— ì˜í•´ ì¬ëŸ‰ì´ 0ìœ¼ë¡œ ìˆ˜ì¶•ë˜ëŠ” ê²½ìš°ëŠ” ìˆìŠµë‹ˆë‹¤.", precedent: "ì¬ëŸ‰ê¶Œì˜ ì˜ìœ¼ë¡œì˜ ìˆ˜ì¶•" },
        { id: 3, q: "í–‰ì •ì˜ ê³µì •ë ¥ì€ í–‰ì •í–‰ìœ„ê°€ ìœ„ë²•í•˜ë”ë¼ë„ ê¶Œí•œ ìˆëŠ” ê¸°ê´€ì— ì˜í•´ ì·¨ì†Œë  ë•Œê¹Œì§€ ìœ íš¨í•œ ê²ƒìœ¼ë¡œ í†µìš©ë˜ëŠ” í˜ì„ ë§í•œë‹¤.", a: true, explanation: "ê³µì •ë ¥ì€ í–‰ì •í–‰ìœ„ê°€ ë¹„ë¡ ìœ„ë²•í•˜ë”ë¼ë„ ë‹¹ì—°ë¬´íš¨ê°€ ì•„ë‹Œ í•œ, ê¶Œí•œ ìˆëŠ” ê¸°ê´€ì— ì˜í•´ ì·¨ì†Œë˜ê¸° ì „ê¹Œì§€ ìœ íš¨í•˜ê²Œ ì¡´ì¬í•˜ëŠ” ê²ƒìœ¼ë¡œ ì·¨ê¸‰ë˜ëŠ” íš¨ë ¥ì…ë‹ˆë‹¤.", precedent: "ê³µì •ë ¥ì˜ ê°œë…" },
        { id: 4, q: "ê±´ì¶•í—ˆê°€ì— ë¶™ì€ ê¸°í•œì´ ê·¸ ì‚¬ì—…ì˜ ì„±ê²©ìƒ ë¶€ë‹¹í•˜ê²Œ ì§§ì€ ê²½ìš°, ê·¸ ê¸°í•œì€ ê±´ì¶•í—ˆê°€ ìì²´ì˜ ì¡´ì†ê¸°ê°„ì´ ì•„ë‹Œ í—ˆê°€ì¡°ê±´ì˜ ì¡´ì†ê¸°ê°„ìœ¼ë¡œ ë³¸ë‹¤.", a: true, explanation: "íŒë¡€ëŠ” ê·¸ ê¸°í•œì„ 'ë¶€ê´€' ì¤‘ í•˜ë‚˜ì¸ ë¶€ë‹´ì´ ì•„ë‹ˆë¼ 'í—ˆê°€ ìì²´ì˜ ì¡´ì†ê¸°ê°„'ìœ¼ë¡œ ë³´ë©°, ì¡°ê±´ì´ ì•„ë‹Œ ì¢…ê¸°ë¡œ í•´ì„í•©ë‹ˆë‹¤. ë‹¤ë§Œ ê·¸ ê¸°ê°„ì´ ë¶€ë‹¹í•˜ê²Œ ì§§ì€ ê²½ìš°, ê°±ì‹  ê¸°ê°„ìœ¼ë¡œ ë´…ë‹ˆë‹¤.", precedent: "ëŒ€ë²•ì› 2007. 9. 6. ì„ ê³  2007ë‘8154 íŒê²°" },
        { id: 5, q: "í–‰ì •ì²­ì´ ìˆ˜ìµì  í–‰ì •í–‰ìœ„ë¥¼ í•˜ë©´ì„œ ì‚¬ì „ì— ìƒëŒ€ë°©ê³¼ í˜‘ì•½ì„ ì²´ê²°í•˜ì˜€ë‹¤ë©´, í–‰ì •í–‰ìœ„ì— ëŒ€í•œ ì² íšŒê¶Œì€ ìœ ë³´ëœ ê²ƒìœ¼ë¡œ ë³´ì•„ì•¼ í•œë‹¤.", a: false, explanation: "ìˆ˜ìµì  í–‰ì •í–‰ìœ„ì˜ ì² íšŒëŠ” ë²•ì  ê·¼ê±°ê°€ ìˆê±°ë‚˜ ì² íšŒê¶Œì´ ìœ ë³´ëœ ê²½ìš°, ë˜ëŠ” ì² íšŒí•  ì¤‘ëŒ€í•œ ê³µìµìƒì˜ í•„ìš”ê°€ ìˆëŠ” ê²½ìš°ì— í•œí•˜ì—¬ ê°€ëŠ¥í•˜ë©°, ë‹¨ìˆœíˆ í˜‘ì•½ì„ ì²´ê²°í–ˆë‹¤ê³  í•˜ì—¬ ì² íšŒê¶Œì´ ìœ ë³´ë˜ëŠ” ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤.", precedent: "ì² íšŒì˜ ë²•ì  ê·¼ê±°" },
        // ìƒ˜í”Œ ë¬¸ì œ ì¶”ê°€
        { id: 6, q: "í–‰ì •ìƒ ê°•ì œì§‘í–‰ì˜ ì¢…ë¥˜ì—ëŠ” ëŒ€ì§‘í–‰, ì´í–‰ê°•ì œê¸ˆ, ì§ì ‘ê°•ì œ, ê°•ì œì§•ìˆ˜ê°€ ìˆë‹¤.", a: true, explanation: "í–‰ì •ìƒ ê°•ì œì§‘í–‰ì€ í–‰ì •ëŒ€ì§‘í–‰, ì´í–‰ê°•ì œê¸ˆ(ì§‘í–‰ë²Œ), ì§ì ‘ê°•ì œ, ê°•ì œì§•ìˆ˜ì˜ ë„¤ ê°€ì§€ ìœ í˜•ìœ¼ë¡œ êµ¬ë¶„ë©ë‹ˆë‹¤.", precedent: "í–‰ì •ìƒ ê°•ì œì§‘í–‰ì˜ ì¢…ë¥˜" },
        { id: 7, q: "í–‰ì •ì§€ë„ì— ë¶ˆì‘í•˜ì˜€ë‹¤ëŠ” ì´ìœ ë§Œìœ¼ë¡œ ìƒëŒ€ë°©ì—ê²Œ ë¶ˆì´ìµí•œ ì¡°ì¹˜ë¥¼ í•˜ì—¬ì„œëŠ” ì•ˆ ëœë‹¤ëŠ” ì›ì¹™ì€ ì‹ ë¢°ë³´í˜¸ì˜ ì›ì¹™ì— í•´ë‹¹í•œë‹¤.", a: false, explanation: "ì´ëŠ” í–‰ì •ì ˆì°¨ë²•ìƒ í–‰ì •ì§€ë„ì˜ í•œê³„ì— ê´€í•œ ê·œì •ì´ë©°, 'ë¹„ë¡€ì˜ ì›ì¹™' ë˜ëŠ” 'í–‰ì •ì§€ë„ì˜ ì„ì˜ì„±ì˜ ì›ì¹™'ê³¼ ê´€ë ¨ì´ ê¹ŠìŠµë‹ˆë‹¤. ì‹ ë¢°ë³´í˜¸ì˜ ì›ì¹™ê³¼ëŠ” ì§ì ‘ì ì¸ ê´€ë ¨ì´ ì ìŠµë‹ˆë‹¤.", precedent: "í–‰ì •ì ˆì°¨ë²• ì œ48ì¡°(í–‰ì •ì§€ë„ì˜ í•œê³„)" },
        { id: 8, q: "ë¬´íš¨ì¸ í–‰ì •í–‰ìœ„ì—ëŠ” ê³µì •ë ¥ì´ ì¸ì •ë˜ì§€ ì•ŠëŠ”ë‹¤.", a: true, explanation: "ê³µì •ë ¥ì€ í–‰ì •í–‰ìœ„ê°€ ë¹„ë¡ ìœ„ë²•í•˜ë”ë¼ë„ ë‹¹ì—°ë¬´íš¨ê°€ ì•„ë‹Œ í•œ, ì·¨ì†Œë˜ê¸° ì „ê¹Œì§€ ìœ íš¨í•˜ê²Œ ì¡´ì¬í•˜ëŠ” ê²ƒìœ¼ë¡œ ì·¨ê¸‰í•˜ëŠ” íš¨ë ¥ì…ë‹ˆë‹¤. ë‹¹ì—°ë¬´íš¨ì¸ í–‰ì •í–‰ìœ„ì—ëŠ” ì²˜ìŒë¶€í„° ì•„ë¬´ëŸ° íš¨ë ¥ì´ ë°œìƒí•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ê³µì •ë ¥ì´ ì¸ì •ë  ì—¬ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.", precedent: "ê³µì •ë ¥ê³¼ ë¬´íš¨" },
        { id: 9, q: "ë¶€ê´€ ì¤‘ ë¶€ë‹´ì€ í–‰ì •í–‰ìœ„ì™€ëŠ” ë³„ê°œë¡œ ë…ë¦½í•˜ì—¬ í–‰ì •ìŸì†¡ì˜ ëŒ€ìƒì´ ë  ìˆ˜ ìˆë‹¤.", a: true, explanation: "ë¶€ê´€ ì¤‘ ë¶€ë‹´(ì˜ë¬´ ë¶€ê³¼)ì€ ë…ë¦½ëœ í–‰ì •í–‰ìœ„ë¡œì„œì˜ ì„±ê²©ì„ ê°€ì§€ë¯€ë¡œ, ê·¸ ìì²´ë§Œìœ¼ë¡œ ì·¨ì†Œì†Œì†¡ ë“± í–‰ì •ìŸì†¡ì˜ ëŒ€ìƒì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", precedent: "ë¶€ë‹´ì˜ ë…ë¦½ ìŸì†¡ ê°€ëŠ¥ì„±" },
        { id: 10, q: "í–‰ì •ì ˆì°¨ë²•ì€ ì²˜ë¶„ì˜ ì‚¬ì „ í†µì§€ ì‹œ ë‹¹ì‚¬ìê°€ ì˜ê²¬ ì œì¶œ ê¸°í•œ ë‚´ì— ì˜ê²¬ ì œì¶œì„ í•˜ì§€ ì•Šì€ ê²½ìš° ì²­ë¬¸ì„ ì‹¤ì‹œí•˜ë„ë¡ ì˜ë¬´í™”í•˜ê³  ìˆë‹¤.", a: false, explanation: "ì˜ê²¬ ì œì¶œ ê¸°í•œ ë‚´ ì˜ê²¬ì„ ì œì¶œí•˜ì§€ ì•Šì€ ê²½ìš° ë°˜ë“œì‹œ ì²­ë¬¸ì„ ì‹¤ì‹œí•´ì•¼ í•˜ëŠ” ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤. ì²­ë¬¸ì€ ë²•ë ¹ì—ì„œ ê·œì •í•˜ê±°ë‚˜ í•„ìš”í•˜ë‹¤ê³  ì¸ì •í•  ë•Œ ì‹¤ì‹œí•©ë‹ˆë‹¤.", precedent: "í–‰ì •ì ˆì°¨ë²•ìƒ ì²­ë¬¸" },
    ];
    
    let currentQuestions = [...questions]; // ì‹¤ì œ í€´ì¦ˆì— ì‚¬ìš©ë˜ëŠ” ë¬¸ì œ ë°°ì—´ (ë³µìŠµ ì‹œ ë³€ê²½ë¨)
    let currentQuestionIndex = 0; // í˜„ì¬ ë¬¸ì œ ì¸ë±ìŠ¤ (0ë¶€í„° ì‹œì‘)
    let correctCount = 0;
    let incorrectCount = 0;
    let incorrectQuestions = []; // ì˜¤ë‹µ ì €ì¥ ë°°ì—´

    // --- DOM ìš”ì†Œ ---
    const scoreEl = document.getElementById('score');
    const currentIndexEl = document.getElementById('current-index');
    const totalQuestionsEl = document.getElementById('total-questions');
    const correctCountEl = document.getElementById('correct-count');
    const incorrectCountEl = document.getElementById('incorrect-count');
    const questionIdEl = document.getElementById('question-id');
    const questionTextEl = document.getElementById('question-text');
    const btnO = document.getElementById('btn-o');
    const btnX = document.getElementById('btn-x');
    const answerButtons = document.getElementById('answer-buttons');
    const resultArea = document.getElementById('result-area');
    const resultMessageEl = document.getElementById('result-message');
    const explanationTextEl = document.getElementById('explanation-text');
    const precedentTextEl = document.getElementById('precedent-text');
    const btnNext = document.getElementById('btn-next');
    const quizArea = document.getElementById('quiz-area');
    const startEndScreen = document.getElementById('start-end-screen');
    const finalMessageEl = document.getElementById('final-message');
    const btnStart = document.getElementById('btn-start');
    const btnReviewIncorrect = document.getElementById('btn-review-incorrect');
    const btnShowIncorrect = document.getElementById('btn-show-incorrect');
    
    // ì˜¤ë‹µ ë…¸íŠ¸ ëª¨ë‹¬ ê´€ë ¨
    const incorrectNoteModal = document.getElementById('incorrect-note-modal');
    const incorrectListEl = document.getElementById('incorrect-list');
    const noIncorrectEl = document.getElementById('no-incorrect');

    // --- Firestore ë°ì´í„° ê´€ë¦¬ í•¨ìˆ˜ ---

    /**
     * Firestoreì—ì„œ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ë¡œë“œí•˜ê³  ì˜¤ë‹µ ë…¸íŠ¸ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
     */
    async function loadUserData() {
        if (!isAuthReady) {
            console.log("ì¸ì¦ ì¤€ë¹„ê°€ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë°ì´í„° ë¡œë“œ ë³´ë¥˜.");
            return;
        }
        
        const docRef = doc(db, "artifacts", appId, "users", userId, "quiz_data", "incorrect_note");
        try {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                // Firestoreì— ì €ì¥ëœ JSON ë¬¸ìì—´ì„ íŒŒì‹±
                incorrectQuestions = JSON.parse(data.incorrectQuestionsJson || '[]');
                console.log("ì˜¤ë‹µ ë…¸íŠ¸ ë¡œë“œ ì„±ê³µ:", incorrectQuestions.length, "ê°œ");
            } else {
                console.log("ì˜¤ë‹µ ë…¸íŠ¸ ë°ì´í„° ì—†ìŒ. ìƒˆ ë…¸íŠ¸ ì‹œì‘.");
            }
        } catch (error) {
            console.error("ì˜¤ë‹µ ë…¸íŠ¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¡œì»¬ì—ì„œ ë¹ˆ ë°°ì—´ë¡œ ì‹œì‘
            incorrectQuestions = [];
        }
        updateEndScreenButtons(); // ë°ì´í„° ë¡œë“œ í›„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    }
    
    /**
     * í˜„ì¬ ì˜¤ë‹µ ë…¸íŠ¸ë¥¼ Firestoreì— ì €ì¥í•©ë‹ˆë‹¤.
     */
    async function saveUserData() {
        if (!isAuthReady) {
            console.log("ì¸ì¦ ì¤€ë¹„ê°€ ë˜ì§€ ì•Šì•„ ì˜¤ë‹µ ë…¸íŠ¸ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const docRef = doc(db, "artifacts", appId, "users", userId, "quiz_data", "incorrect_note");
        // Firestoreì— ì €ì¥í•˜ê¸° ìœ„í•´ ë°°ì—´ì„ JSON ë¬¸ìì—´ë¡œ ì§ë ¬í™”
        const incorrectQuestionsJson = JSON.stringify(incorrectQuestions);

        try {
            await setDoc(docRef, { 
                incorrectQuestionsJson: incorrectQuestionsJson,
                updatedAt: new Date().toISOString()
            }, { merge: true });
            console.log("ì˜¤ë‹µ ë…¸íŠ¸ ì €ì¥ ì„±ê³µ:", incorrectQuestions.length, "ê°œ");
        } catch (error) {
            console.error("ì˜¤ë‹µ ë…¸íŠ¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    }

    // --- í€´ì¦ˆ ë¡œì§ í•¨ìˆ˜ ---

    /**
     * í€´ì¦ˆ ì‹œì‘ ìƒíƒœë¡œ UIë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
     * @param {Array} questionsToUse - í€´ì¦ˆì— ì‚¬ìš©í•  ë¬¸ì œ ë°°ì—´
     * @param {boolean} isReview - ë³µìŠµ ëª¨ë“œì¸ì§€ ì—¬ë¶€
     */
    function startQuiz(questionsToUse = questions, isReview = false) {
        currentQuestions = questionsToUse;
        currentQuestionIndex = 0;
        correctCount = 0;
        incorrectCount = 0;
        
        // ë³µìŠµ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ì „ì²´ ì˜¤ë‹µ ë…¸íŠ¸ ë°°ì—´ ì´ˆê¸°í™” (ìƒˆë¡œìš´ í€´ì¦ˆ ì‹œì‘)
        if (!isReview) {
            // Note: ì‹¤ì œ ì˜¤ë‹µ ë…¸íŠ¸ ë°°ì—´ì€ save/loadë¥¼ ìœ„í•´ ìœ ì§€í•˜ê³ , ì—¬ê¸°ì„œ ì¹´ìš´íŠ¸ë§Œ ì´ˆê¸°í™”
        }

        totalQuestionsEl.textContent = currentQuestions.length;
        quizArea.classList.remove('hidden');
        startEndScreen.classList.add('hidden');

        loadQuestion();
        updateScoreboard();
    }

    /**
     * ë‹¤ìŒ ë¬¸ì œ ë¡œë“œ ë° UI ì—…ë°ì´íŠ¸
     */
    function loadQuestion() {
        if (currentQuestionIndex >= currentQuestions.length) {
            showEndScreen();
            return;
        }

        const currentQ = currentQuestions[currentQuestionIndex];
        
        // UI ì´ˆê¸°í™”
        questionIdEl.textContent = `ë¬¸ì œ ${currentQ.id}.`;
        questionTextEl.textContent = currentQ.q;
        resultArea.classList.add('hidden');
        btnNext.classList.add('hidden');
        btnO.classList.remove('bg-gray-400', 'hover:bg-gray-400', 'bg-green-700', 'bg-red-700');
        btnX.classList.remove('bg-gray-400', 'hover:bg-gray-400', 'bg-green-700', 'bg-red-700');
        btnO.classList.add('bg-green-500', 'hover:bg-green-600');
        btnX.classList.add('bg-red-500', 'hover:bg-red-600');
        btnO.disabled = false;
        btnX.disabled = false;
        
        currentIndexEl.textContent = currentQuestionIndex + 1;
    }

    /**
     * ë‹µë³€ ì œì¶œ ë° ì •ë‹µ í™•ì¸
     * @param {boolean} userAnswer - ì‚¬ìš©ìê°€ ì„ íƒí•œ ë‹µë³€ (O: true, X: false)
     */
    function submitAnswer(userAnswer) {
        const currentQ = currentQuestions[currentQuestionIndex];
        const isCorrect = (userAnswer === currentQ.a);
        
        btnO.disabled = true;
        btnX.disabled = true;

        // ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½ (ì„ íƒëœ ë²„íŠ¼ì„ ê°•ì¡°)
        if (userAnswer) { // Oë¥¼ ì„ íƒí–ˆì„ ë•Œ
            btnO.classList.remove('bg-green-500', 'hover:bg-green-600');
            btnO.classList.add(isCorrect ? 'bg-green-700' : 'bg-red-700');
            btnX.classList.add('bg-gray-400');
            btnX.classList.remove('bg-red-500', 'hover:bg-red-600');
        } else { // Xë¥¼ ì„ íƒí–ˆì„ ë•Œ
            btnX.classList.remove('bg-red-500', 'hover:bg-red-600');
            btnX.classList.add(isCorrect ? 'bg-green-700' : 'bg-red-700');
            btnO.classList.add('bg-gray-400');
            btnO.classList.remove('bg-green-500', 'hover:bg-green-600');
        }

        if (isCorrect) {
            correctCount++;
            resultMessageEl.textContent = "ì •ë‹µì…ë‹ˆë‹¤! ğŸ˜Š";
            resultArea.className = 'mt-6 p-4 rounded-xl bg-green-100 border border-green-300 transition-all duration-300';
        } else {
            incorrectCount++;
            resultMessageEl.textContent = "ì˜¤ë‹µì…ë‹ˆë‹¤. ğŸ˜¥ (ì •ë‹µ: " + (currentQ.a ? 'O' : 'X') + ")";
            resultArea.className = 'mt-6 p-4 rounded-xl bg-red-100 border border-red-300 transition-all duration-300';
            
            // ì˜¤ë‹µ ë…¸íŠ¸ì— ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
            const exists = incorrectQuestions.some(q => q.id === currentQ.id);
            if (!exists) {
                incorrectQuestions.push(currentQ);
                saveUserData(); // ì˜¤ë‹µ ë°œìƒ ì‹œ ì¦‰ì‹œ ì €ì¥ ì‹œë„
            }
        }
        
        // í•´ì„¤ í‘œì‹œ
        explanationTextEl.textContent = currentQ.explanation;
        precedentTextEl.textContent = `[íŒë¡€/ê°œë…] ${currentQ.precedent}`;
        resultArea.classList.remove('hidden');
        btnNext.classList.remove('hidden');
        
        updateScoreboard();
    }
    
    /**
     * ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°
     */
    function nextQuestion() {
        currentQuestionIndex++;
        loadQuestion();
    }

    /**
     * ì ìˆ˜íŒ ì—…ë°ì´íŠ¸
     */
    function updateScoreboard() {
        correctCountEl.textContent = correctCount;
        incorrectCountEl.textContent = incorrectCount;
    }
    
    /**
     * í€´ì¦ˆ ì¢…ë£Œ í™”ë©´ í‘œì‹œ
     */
    function showEndScreen() {
        quizArea.classList.add('hidden');
        startEndScreen.classList.remove('hidden');
        
        const total = currentQuestions.length;
        const percentage = total > 0 ? ((correctCount / total) * 100).toFixed(1) : 0;
        
        finalMessageEl.innerHTML = `
            <p class="text-3xl font-extrabold text-blue-800 mb-4">ğŸ‰ í€´ì¦ˆ ì¢…ë£Œ! ğŸ‰</p>
            <p class="text-2xl font-semibold text-gray-700">ì´ ${total}ë¬¸ì œ ì¤‘ <span class="text-green-600">${correctCount}ê°œ</span> ì •ë‹µ!</p>
            <p class="text-xl font-medium text-gray-500 mt-2">ì •ë‹µë¥ : <span class="text-blue-600">${percentage}%</span></p>
        `;
        
        // ì˜¤ë‹µ ë…¸íŠ¸ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        updateEndScreenButtons();
    }
    
    /**
     * ì˜¤ë‹µ ë…¸íŠ¸ ê´€ë ¨ ë²„íŠ¼ì˜ í‘œì‹œ ì—¬ë¶€ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     */
    function updateEndScreenButtons() {
        if (incorrectQuestions.length > 0) {
            btnShowIncorrect.classList.remove('hidden');
            btnReviewIncorrect.classList.remove('hidden');
        } else {
            btnShowIncorrect.classList.add('hidden');
            btnReviewIncorrect.classList.add('hidden');
        }
        // ì‹œì‘ ë²„íŠ¼ì€ í•­ìƒ í‘œì‹œ
        btnStart.textContent = "ë‹¤ì‹œ ì‹œì‘í•˜ê¸° (ì „ì²´)";
    }


    /**
     * ì˜¤ë‹µ ë…¸íŠ¸ ëª¨ë‹¬ì„ í‘œì‹œí•˜ê³  ë‚´ìš©ì„ ì±„ì›ë‹ˆë‹¤.
     */
    window.showIncorrectNote = function showIncorrectNote() {
        closeIncorrectNote(); // ê¸°ì¡´ ëª¨ë‹¬ ë‹«ê¸°
        incorrectNoteModal.classList.remove('hidden');
        incorrectListEl.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

        if (incorrectQuestions.length === 0) {
            noIncorrectEl.classList.remove('hidden');
        } else {
            noIncorrectEl.classList.add('hidden');
            incorrectQuestions.forEach((q, index) => {
                const item = document.createElement('div');
                item.className = 'border p-4 rounded-xl bg-red-50 shadow-md';
                item.innerHTML = `
                    <p class="font-semibold text-red-600 text-lg">ë¬¸ì œ ${q.id}. (ì •ë‹µ: ${q.a ? 'O' : 'X'})</p>
                    <p class="mt-1 text-gray-800 text-base">${q.q}</p>
                    <details class="mt-3 bg-white p-3 rounded-lg border border-red-200">
                        <summary class="font-medium text-blue-600 cursor-pointer">ìƒì„¸ í•´ì„¤ ë³´ê¸°</summary>
                        <p class="text-sm mt-2 text-gray-700 leading-relaxed">${q.explanation}</p>
                        <p class="text-xs text-gray-500 italic mt-2 pt-2 border-t">[íŒë¡€/ê°œë…] ${q.precedent}</p>
                    </details>
                `;
                incorrectListEl.appendChild(item);
            });
        }
    }

    /**
     * ì˜¤ë‹µ ë…¸íŠ¸ ëª¨ë‹¬ì„ ë‹«ìŠµë‹ˆë‹¤.
     */
    window.closeIncorrectNote = function closeIncorrectNote() {
        incorrectNoteModal.classList.add('hidden');
    }

    /**
     * ì˜¤ë‹µ ë¬¸ì œë§Œìœ¼ë¡œ ë³µìŠµ í€´ì¦ˆë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
     */
    function reviewIncorrectQuestions() {
        if (incorrectQuestions.length > 0) {
            // ì˜¤ë‹µ ë¬¸ì œë§Œìœ¼ë¡œ ìƒˆë¡œìš´ í€´ì¦ˆ ì‹œì‘
            startQuiz(incorrectQuestions, true); 
        } else {
            // ì˜¤ë‹µì´ ì—†ì„ ê²½ìš° ëª¨ë‹¬ í‘œì‹œ
            showIncorrectNote();
        }
    }

    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
    btnO.addEventListener('click', () => submitAnswer(true));
    btnX.addEventListener('click', () => submitAnswer(false));
    btnNext.addEventListener('click', nextQuestion);
    btnStart.addEventListener('click', () => startQuiz(questions));
    btnShowIncorrect.addEventListener('click', showIncorrectNote);
    btnReviewIncorrect.addEventListener('click', reviewIncorrectQuestions);
    
    // ì´ˆê¸° ë¡œë“œ ì‹œ ì‹œì‘ í™”ë©´ í‘œì‹œ
    window.onload = function() {
        quizArea.classList.add('hidden');
        startEndScreen.classList.remove('hidden');
        totalQuestionsEl.textContent = questions.length;
        updateEndScreenButtons();
    }
    
</script>
</body>
</html>
